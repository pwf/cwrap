#!/usr/bin/env bash
set -euo pipefail

CWRAP_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/cwrap"

# ---------------------------------------------------------------------------
# Arg parsing
# ---------------------------------------------------------------------------
DO_BUILD=0
INSTANCE=""
CLI_DIRS=()
PASSTHROUGH=()

while [[ $# -gt 0 ]]; do
    case "$1" in
        help|--help|-h)
            cat <<'EOF'
Usage:
  cwrap build [-i <instance>]              build image from instances/<name>/Containerfile
  cwrap [-i <instance>] [dir...]           drop into bash inside the container
  cwrap [-i <instance>] [dir...] -- <args> run: claude --add-dir <dirs> <args>

Options:
  -i, --instance <name>  use a specific instance (default: default_instance from config)
  -h, --help             show this help

Config: ~/.config/cwrap/
  config                     global config (default_instance=<name>)
  instances/<name>/
    Containerfile            per-instance image definition
    cwrap.conf               CWRAP_DIRS=(...) — extra dirs to mount
    home/                    mounted as /home/cwrap inside container
EOF
            exit 0
            ;;
        build)
            DO_BUILD=1
            shift
            ;;
        -i|--instance)
            [[ $# -lt 2 ]] && { echo "cwrap: -i requires an argument" >&2; exit 1; }
            INSTANCE="$2"
            shift 2
            ;;
        --)
            shift
            PASSTHROUGH+=("$@")
            break
            ;;
        -*)
            echo "cwrap: unknown option: $1" >&2
            exit 1
            ;;
        *)
            CLI_DIRS+=("$1")
            shift
            ;;
    esac
done

# ---------------------------------------------------------------------------
# Runtime
# ---------------------------------------------------------------------------
if ! command -v podman &>/dev/null; then
    echo "cwrap: podman not found" >&2
    exit 1
fi
RUNTIME=podman

# ---------------------------------------------------------------------------
# Source global config (sets default_instance)
# ---------------------------------------------------------------------------
if [[ -f "$CWRAP_DIR/config" ]]; then
    # shellcheck source=/dev/null
    source "$CWRAP_DIR/config"
fi

# Resolve instance
if [[ -z "$INSTANCE" ]]; then
    INSTANCE="${default_instance:-}"
fi
if [[ -z "$INSTANCE" ]]; then
    echo "cwrap: no instance specified and no default_instance in $CWRAP_DIR/config" >&2
    exit 1
fi

# Validate instance name
if [[ "$INSTANCE" =~ \.\. ]] || [[ ! "$INSTANCE" =~ ^[a-zA-Z0-9_.-]+$ ]]; then
    echo "cwrap: invalid instance name: $INSTANCE" >&2
    exit 1
fi

INSTANCE_DIR="$CWRAP_DIR/instances/$INSTANCE"
INSTANCE_HOME_DIR="$CWRAP_DIR/instances/$INSTANCE/home"

# ---------------------------------------------------------------------------
# build
# ---------------------------------------------------------------------------
if [[ "$DO_BUILD" -eq 1 ]]; then
    mkdir -p "$INSTANCE_DIR"
    exec "$RUNTIME" build -t "cwrap-${INSTANCE}:latest" -f "$INSTANCE_DIR/Containerfile" "$INSTANCE_DIR"
fi

# ---------------------------------------------------------------------------
# run
# ---------------------------------------------------------------------------

# Source instance config (sets CWRAP_DIRS)
CWRAP_DIRS=()
if [[ -f "$INSTANCE_DIR/cwrap.conf" ]]; then
    # shellcheck source=/dev/null
    source "$INSTANCE_DIR/cwrap.conf"
fi

# Merge CLI dirs
for d in "${CLI_DIRS[@]}"; do
    CWRAP_DIRS+=("$d")
done

# Check image exists
IMAGE="cwrap-${INSTANCE}:latest"
if ! "$RUNTIME" image exists "$IMAGE" 2>/dev/null; then
    echo "cwrap: image $IMAGE not found — run: cwrap build -i $INSTANCE" >&2
    exit 1
fi

mkdir -p "$INSTANCE_HOME_DIR/.config/claude"
VOL_FLAGS=(-v "$INSTANCE_HOME_DIR:/home/cwrap:z")

# Build --add-dir flags for claude and extra volume mounts
ADD_DIR_FLAGS=()
declare -A _seen_dirs=()
for dir in "${CWRAP_DIRS[@]}"; do
    dir="$(realpath -m "$dir")"
    [[ -n "${_seen_dirs[$dir]+x}" ]] && continue
    _seen_dirs[$dir]=1
    VOL_FLAGS+=(-v "$dir:$dir:z")
    ADD_DIR_FLAGS+=(--add-dir "$dir")
done

# Pass through terminal detection and ANTHROPIC_* env vars
ENV_FLAGS=()
for var in TERM COLORTERM TERM_PROGRAM TERM_PROGRAM_VERSION; do
    [[ -n "${!var+x}" ]] && ENV_FLAGS+=(-e "$var=${!var}")
done
while IFS='=' read -r key _; do
    ENV_FLAGS+=(-e "$key=${!key}")
done < <(env | grep '^ANTHROPIC_')

if [[ ${#PASSTHROUGH[@]} -gt 0 ]]; then
    CMD_ARGS=(claude "${ADD_DIR_FLAGS[@]}" "${PASSTHROUGH[@]}")
else
    CMD_ARGS=(bash)
fi

WORKDIR_FLAGS=()
if [[ ${#CLI_DIRS[@]} -gt 0 ]]; then
    WORKDIR_FLAGS=(-w "$(realpath -m "${CLI_DIRS[0]}")")
fi

exec "$RUNTIME" run --rm -it --userns=keep-id \
    "${ENV_FLAGS[@]}" \
    "${VOL_FLAGS[@]}" \
    "${WORKDIR_FLAGS[@]}" \
    "$IMAGE" \
    "${CMD_ARGS[@]}"
